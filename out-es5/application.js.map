{"version":3,"sources":["../out/application.js"],"names":["__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","Application","Page","React","require","ReactDOM","chitu","errors_1","data_loader_1","arguments","component","DefaultPageNodeParser","modulesPath","nodes","endsWith","substr","length","pageName","node","path","split","join","action","createDefaultAction","loadjs","name","url","page","app","actionExports","Errors","exportsCanntNull","canntFindAction","props","data","events","shown","showing","hidden","hiding","source","createService","type","LOAD_DATA","partialData","assign","element","createElement","render","TargetUrlVariableName","DefaultPage","args","undefined","parser","createPageNodeParser","defaultPage","pageType","mode","run","routeString","getRouteString","showPage","parseUrl","searchIndex","indexOf","search","pathName","routers","values","i","m","match","controller","Error","q","r","pareeUrlQuery","arr","filter","o","window","location","pathname","trim","p"],"mappings":"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","sourcesContent":["\"use strict\";\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.Application = exports.Page = void 0;\r\nconst React = require(\"react\");\r\nconst ReactDOM = require(\"react-dom\");\r\nconst chitu = require(\"maishu-chitu\");\r\nconst errors_1 = require(\"./errors\");\r\nconst data_loader_1 = require(\"./data-loader\");\r\nclass Page extends chitu.Page {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.component = null;\r\n    }\r\n}\r\nexports.Page = Page;\r\n// export let PageContext = React.createContext<{ page: Page | null }>({ page: null })\r\nclass DefaultPageNodeParser {\r\n    constructor(modulesPath) {\r\n        this.nodes = {};\r\n        this.modulesPath = modulesPath.endsWith(\"/\") ? modulesPath.substr(0, modulesPath.length - 1) : modulesPath;\r\n    }\r\n    parse(pageName) {\r\n        let node = this.nodes[pageName];\r\n        if (node == null) {\r\n            let path = `${pageName}`.split('_').join('/');\r\n            if (this.modulesPath) {\r\n                path = `${this.modulesPath}/${path}`;\r\n            }\r\n            node = { action: this.createDefaultAction(path, (path) => this.loadjs(path)), name: pageName };\r\n            this.nodes[pageName] = node;\r\n        }\r\n        return node;\r\n    }\r\n    createDefaultAction(url, loadjs) {\r\n        return (page, app) => __awaiter(this, void 0, void 0, function* () {\r\n            let actionExports = yield loadjs(url);\r\n            if (!actionExports)\r\n                throw errors_1.Errors.exportsCanntNull(url);\r\n            let action = actionExports['default'];\r\n            if (action == null) {\r\n                throw errors_1.Errors.canntFindAction(page.name);\r\n            }\r\n            let props = {\r\n                app: app,\r\n                data: page.data,\r\n                events: {\r\n                    shown: page.shown,\r\n                    showing: page.showing,\r\n                    hidden: page.hidden,\r\n                    hiding: page.hiding,\r\n                },\r\n                source: page,\r\n                createService(type) {\r\n                    return page.createService(type);\r\n                }\r\n            };\r\n            if (typeof action[data_loader_1.LOAD_DATA] == \"function\") {\r\n                let partialData = yield action[data_loader_1.LOAD_DATA](props);\r\n                Object.assign(props.data, partialData);\r\n            }\r\n            let element = React.createElement(action, props);\r\n            let component = ReactDOM.render(element, page.element);\r\n            page.component = component;\r\n        });\r\n    }\r\n}\r\nconst TargetUrlVariableName = \"targetUrl\";\r\nconst DefaultPage = \"index\";\r\nclass Application extends chitu.Application {\r\n    constructor(args) {\r\n        args = args || {};\r\n        if (args.modulesPath === undefined) {\r\n            args.modulesPath = \"modules\";\r\n        }\r\n        if (!args.parser)\r\n            args.parser = Application.createPageNodeParser(args.modulesPath);\r\n        super(args);\r\n        args.parser.app = this;\r\n        args.parser.loadjs = (path) => this.loadjs(path);\r\n        this.defaultPage = args.defaultPage || DefaultPage;\r\n        this.pageType = Page;\r\n        let mode = args.mode || \"hash\";\r\n        if (mode == \"history\") {\r\n            this.run = () => {\r\n                let routeString = this.getRouteString();\r\n                this.showPage(routeString);\r\n            };\r\n            this.parseUrl = (url) => {\r\n                let searchIndex = url.indexOf(\"?\");\r\n                let search;\r\n                let pathName;\r\n                if (searchIndex > 0) {\r\n                    search = url.substr(searchIndex);\r\n                    pathName = url.substr(0, searchIndex);\r\n                }\r\n                else {\r\n                    pathName = url;\r\n                }\r\n                let routers = args === null || args === void 0 ? void 0 : args.routers;\r\n                let values = {};\r\n                if (routers != null) {\r\n                    for (let i = 0; i < routers.length; i++) {\r\n                        let m = routers[i].match(pathName);\r\n                        if (m) {\r\n                            let { controller, action } = m;\r\n                            if (!controller)\r\n                                throw new Error(`Can not get controller from route data.`);\r\n                            if (!action)\r\n                                throw new Error(`Can not get action from route data.`);\r\n                            Object.assign(values, m);\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                if (search) {\r\n                    let q = search.substr(1);\r\n                    let r = q ? this.pareeUrlQuery(q) : {};\r\n                    Object.assign(values, r);\r\n                }\r\n                let arr = pathName.split(\"/\").filter(o => o);\r\n                let pageName = arr.length == 0 ? \"index\" : arr.join(\"_\");\r\n                return { pageName, values };\r\n            };\r\n        }\r\n    }\r\n    getRouteString() {\r\n        let routeString = window[TargetUrlVariableName];\r\n        if (!routeString) {\r\n            routeString = location.pathname || this.defaultPage;\r\n            if (location.search) {\r\n                routeString = routeString + location.search;\r\n            }\r\n        }\r\n        routeString = routeString.trim();\r\n        if (routeString[0] == '/') {\r\n            routeString = routeString.substr(1);\r\n        }\r\n        return routeString;\r\n    }\r\n    static createPageNodeParser(modulesPath) {\r\n        let p = new DefaultPageNodeParser(modulesPath);\r\n        return p;\r\n    }\r\n}\r\nexports.Application = Application;\r\n"],"file":"application.js"}